# 修復「新增學生失敗」問題

## 問題原因

前端代碼使用了 `http://localhost:5000` 來訪問 API，但在部署環境中：
- 前端運行在 port 3000
- 後端運行在 port 5000
- 用戶通過 Nginx (port 80) 訪問

當前端嘗試從瀏覽器訪問 `http://localhost:5000` 時，會失敗，因為：
1. 瀏覽器的 localhost 指向用戶的電腦，不是伺服器
2. 跨域請求被阻擋

## 已修復的內容

✅ **前端組件**
- `StudentManagement.tsx` - 學生管理
- `CourseManagement.tsx` - 課程管理  
- `PaymentManagement.tsx` - 繳費管理

所有 API 請求從 `http://localhost:5000/api/...` 改為 `/api/...`

✅ **前端配置**
- `client/package.json` - 添加 proxy 設定

✅ **部署腳本**
- `簡易部署.sh` - 添加 Nginx 配置，自動轉發 `/api` 請求到後端

✅ **錯誤處理**
- 所有 API 請求現在會顯示具體錯誤訊息，不再只顯示「操作失敗」

## 部署步驟

### 方案 1：完整重新部署（推薦）

在 Ubuntu 伺服器上執行：

```bash
# 1. 上傳更新後的代碼到伺服器
# 使用 Git、SCP 或其他方式

# 2. 執行部署腳本
chmod +x 簡易部署.sh
./簡易部署.sh
```

### 方案 2：只更新前端

如果後端沒問題，只需要更新前端：

```bash
# 1. 上傳更新後的前端代碼

# 2. 執行前端更新腳本
chmod +x update-frontend.sh
./update-frontend.sh
```

### 方案 3：手動更新

```bash
# 1. 進入前端目錄
cd client

# 2. 安裝依賴
npm install

# 3. 建置前端
NODE_OPTIONS="--max-old-space-size=2048" CI=false npm run build

# 4. 回到專案根目錄
cd ..

# 5. 重啟前端服務
pm2 restart tutoring-frontend

# 6. 如果還沒有 Nginx，需要安裝並配置
sudo apt-get install -y nginx

# 7. 建立 Nginx 配置
sudo nano /etc/nginx/sites-available/tutoring-system
```

將以下內容貼入：

```nginx
server {
    listen 80;
    server_name _;
    
    # 後端 API
    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        client_max_body_size 10M;
    }

    # 前端
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

然後執行：

```bash
# 8. 啟用配置
sudo ln -sf /etc/nginx/sites-available/tutoring-system /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# 9. 測試並重啟 Nginx
sudo nginx -t
sudo systemctl restart nginx
```

## 診斷問題

執行診斷腳本檢查所有服務：

```bash
chmod +x diagnose-api.sh
./diagnose-api.sh
```

這會檢查：
- PM2 服務狀態
- 端口佔用情況
- 後端 API 是否正常
- 前端服務是否正常
- Nginx 配置和運行狀態
- 資料庫狀態
- 錯誤日誌
- 實際測試新增學生功能

## 訪問方式

部署完成後：

### 通過 Nginx（推薦）
- 應用網址: `http://你的伺服器IP`
- API 會自動轉發到後端

### 直接訪問
- 前端: `http://你的伺服器IP:3000`
- 後端: `http://你的伺服器IP:5000`

## 測試新增學生

1. 打開瀏覽器訪問 `http://你的伺服器IP`
2. 點擊「學生管理」
3. 點擊「新增學生」
4. 填寫學生資料
5. 點擊「新增學生」按鈕

如果還是失敗：
- 打開瀏覽器開發者工具（F12）
- 查看 Console 標籤的錯誤訊息
- 查看 Network 標籤的請求詳情
- 執行 `./diagnose-api.sh` 查看伺服器端狀態

## 常見問題

### Q: 顯示「操作失敗：無法連接到伺服器」
**A:** 檢查：
1. 後端服務是否運行：`pm2 list`
2. 後端 API 是否正常：`curl http://localhost:5000/api/students`
3. Nginx 是否運行：`sudo systemctl status nginx`

### Q: 顯示「操作失敗：[具體錯誤]」
**A:** 這是後端返回的錯誤，檢查：
1. 資料庫是否存在：`ls -lh tutoring.db`
2. 後端日誌：`pm2 logs tutoring-backend`
3. 資料表結構是否正確

### Q: 防火牆問題
**A:** 確保開放端口：
```bash
# GCP 防火牆規則
gcloud compute firewall-rules create allow-http --allow tcp:80

# Ubuntu 防火牆
sudo ufw allow 80/tcp
sudo ufw allow 3000/tcp
sudo ufw allow 5000/tcp
```

## 管理命令

```bash
# 查看服務狀態
./manage.sh status

# 查看日誌
./manage.sh logs

# 重啟服務
./manage.sh restart

# 備份資料庫
./manage.sh backup

# 診斷問題
./diagnose-api.sh
```

## 如果還是不行

1. 收集診斷資訊：
```bash
./diagnose-api.sh > diagnosis.txt
pm2 logs --lines 100 > pm2-logs.txt
```

2. 檢查瀏覽器 Console 的錯誤訊息（F12）

3. 提供這些資訊以便進一步診斷
