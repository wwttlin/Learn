# 🚀 快速修復指南 - 新增學生失敗問題

## 問題
在 Ubuntu 部署後，新增學生時出現「操作失敗」錯誤。

## 原因
前端使用 `http://localhost:5000` 訪問 API，在生產環境中無法正常工作。

## 解決方案

### ✅ 已修復的檔案
- `client/src/components/StudentManagement.tsx`
- `client/src/components/CourseManagement.tsx`
- `client/src/components/PaymentManagement.tsx`
- `client/package.json`
- `簡易部署.sh`

---

## ⚠️ 如果 Nginx 有問題

### 快速修復 Nginx
```bash
chmod +x fix-nginx.sh setup-nginx.sh
./fix-nginx.sh
```

如果需要重新配置：
```bash
./setup-nginx.sh
```

詳細說明請看：[Nginx設定指南.md](./Nginx設定指南.md)

---

## 📤 步驟 1: 上傳代碼到伺服器

### 方法 A: 使用 Windows 批次檔（最簡單）
```cmd
upload-fix.bat
```
按照提示輸入伺服器資訊。

### 方法 B: 使用 Git（推薦）
```bash
# 在 Windows 上
git add .
git commit -m "修復新增學生 API 路徑問題"
git push

# 在 Ubuntu 伺服器上
cd ~/tutoring-system
git pull
```

### 方法 C: 使用 SCP
```bash
# 上傳整個專案
scp -r client/ user@server-ip:~/tutoring-system/
scp 簡易部署.sh user@server-ip:~/tutoring-system/
```

---

## 🔧 步驟 2: 在 Ubuntu 伺服器上部署

### 選項 1: 只更新前端（快速，5 分鐘）
```bash
cd ~/tutoring-system
chmod +x update-frontend.sh
./update-frontend.sh
```

### 選項 2: 完整重新部署（推薦，10 分鐘）
```bash
cd ~/tutoring-system
chmod +x 簡易部署.sh
./簡易部署.sh
```

---

## 🔍 步驟 3: 診斷和測試

### 運行診斷腳本
```bash
chmod +x diagnose-api.sh
./diagnose-api.sh
```

### 手動測試
```bash
# 測試後端 API
curl http://localhost:5000/api/students

# 測試通過 Nginx
curl http://localhost/api/students

# 查看服務狀態
pm2 list

# 查看日誌
pm2 logs
```

---

## 🌐 步驟 4: 瀏覽器測試

1. 打開 `http://你的伺服器IP`
2. 進入「學生管理」
3. 點擊「新增學生」
4. 填寫資料並提交

### 如果還是失敗
按 F12 打開開發者工具，查看：
- **Console** 標籤：查看 JavaScript 錯誤
- **Network** 標籤：查看 API 請求狀態

---

## 🆘 常見問題

### ❌ 「無法連接到伺服器」
```bash
# 檢查後端
pm2 restart tutoring-backend
pm2 logs tutoring-backend

# 檢查 Nginx
sudo systemctl status nginx
sudo systemctl restart nginx
```

### ❌ 「操作失敗：[錯誤訊息]」
```bash
# 查看後端日誌
pm2 logs tutoring-backend --lines 50

# 檢查資料庫
ls -lh tutoring.db
sqlite3 tutoring.db ".tables"
```

### ❌ 防火牆問題
```bash
# GCP
gcloud compute firewall-rules create allow-http --allow tcp:80

# Ubuntu UFW
sudo ufw allow 80/tcp
sudo ufw status
```

---

## 📋 管理命令速查

```bash
# 查看狀態
./manage.sh status

# 查看日誌
./manage.sh logs

# 重啟服務
./manage.sh restart

# 備份資料庫
./manage.sh backup

# 完整診斷
./diagnose-api.sh
```

---

## ✨ 預期結果

修復後，你應該能夠：
- ✅ 成功新增學生
- ✅ 看到具體的錯誤訊息（如果有錯誤）
- ✅ 通過 `http://伺服器IP` 訪問系統
- ✅ API 請求正常轉發

---

## 📞 需要幫助？

如果問題仍然存在，收集以下資訊：

```bash
# 1. 診斷報告
./diagnose-api.sh > diagnosis.txt

# 2. PM2 日誌
pm2 logs --lines 100 > pm2-logs.txt

# 3. Nginx 狀態
sudo nginx -t > nginx-test.txt 2>&1
```

然後檢查瀏覽器 Console 的錯誤訊息（F12）。
