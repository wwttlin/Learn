# ğŸ”§ å‰ç«¯å»ºç½®å•é¡Œè§£æ±ºæŒ‡å—

## ğŸš¨ å•é¡Œæè¿°
`npm run build` å‘½ä»¤å¡åœ¨åŸ·è¡Œä¸­ï¼Œæ²’æœ‰å®Œæˆä¹Ÿæ²’æœ‰éŒ¯èª¤è¨Šæ¯

## ğŸ” å¸¸è¦‹åŸå› 
1. **è¨˜æ†¶é«”ä¸è¶³** - æœ€å¸¸è¦‹åŸå› 
2. **Node.js ç‰ˆæœ¬å•é¡Œ**
3. **ä¾è³´å¥—ä»¶å•é¡Œ**
4. **ç£ç¢Ÿç©ºé–“ä¸è¶³**
5. **å»ºç½®éç¨‹è¶…æ™‚**

---

## ğŸš€ è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¢åŠ è¨˜æ†¶é«”å’Œ Swapï¼ˆæ¨è–¦ï¼‰

#### æª¢æŸ¥ç•¶å‰è¨˜æ†¶é«”ä½¿ç”¨
```bash
# æŸ¥çœ‹è¨˜æ†¶é«”ä½¿ç”¨æƒ…æ³
free -h

# æŸ¥çœ‹ç£ç¢Ÿç©ºé–“
df -h

# æŸ¥çœ‹ Node.js é€²ç¨‹
ps aux | grep node
```

#### å¢åŠ  Swap ç©ºé–“
```bash
# æª¢æŸ¥ç¾æœ‰ swap
sudo swapon --show

# å»ºç«‹ 1GB swap æª”æ¡ˆ
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# æ°¸ä¹…å•Ÿç”¨ swap
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# é©—è­‰ swap å·²å•Ÿç”¨
free -h
```

### æ–¹æ¡ˆ2ï¼šèª¿æ•´ Node.js è¨˜æ†¶é«”é™åˆ¶

#### å¢åŠ  Node.js è¨˜æ†¶é«”é™åˆ¶
```bash
# è¨­å®šç’°å¢ƒè®Šæ•¸
export NODE_OPTIONS="--max-old-space-size=2048"

# æˆ–åœ¨å»ºç½®æ™‚ç›´æ¥è¨­å®š
NODE_OPTIONS="--max-old-space-size=2048" npm run build
```

#### ä¿®æ”¹ package.jsonï¼ˆæ°¸ä¹…è§£æ±ºï¼‰
```json
{
  "scripts": {
    "build": "NODE_OPTIONS='--max-old-space-size=2048' react-scripts build"
  }
}
```

### æ–¹æ¡ˆ3ï¼šåˆ†æ­¥é©Ÿå»ºç½®

#### æ‰‹å‹•åŸ·è¡Œå»ºç½®æ­¥é©Ÿ
```bash
# é€²å…¥ client ç›®éŒ„
cd client

# æ¸…ç†å¿«å–
npm cache clean --force
rm -rf node_modules package-lock.json

# é‡æ–°å®‰è£ä¾è³´
npm install

# å˜—è©¦å»ºç½®ï¼ˆå¢åŠ è©³ç´°è¼¸å‡ºï¼‰
npm run build --verbose
```

### æ–¹æ¡ˆ4ï¼šä½¿ç”¨æ›¿ä»£å»ºç½®æ–¹æ³•

#### ä½¿ç”¨ yarn æ›¿ä»£ npm
```bash
# å®‰è£ yarn
npm install -g yarn

# ä½¿ç”¨ yarn å»ºç½®
cd client
yarn install
yarn build
```

#### é™ç´š React Scripts ç‰ˆæœ¬
```bash
cd client
npm install react-scripts@4.0.3
npm run build
```

---

## ğŸ”§ ä¿®å¾©è…³æœ¬

### å»ºç«‹è‡ªå‹•ä¿®å¾©è…³æœ¬
```bash
cat > fix-build.sh << 'EOF'
#!/bin/bash

echo "ğŸ”§ ä¿®å¾©å‰ç«¯å»ºç½®å•é¡Œ..."

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

print_info() {
    echo -e "${YELLOW}[â„¹]${NC} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

# æª¢æŸ¥è¨˜æ†¶é«”
MEMORY=$(free -m | awk 'NR==2{printf "%.1f", $3*100/$2 }')
print_info "è¨˜æ†¶é«”ä½¿ç”¨ç‡: ${MEMORY}%"

# æª¢æŸ¥ swap
SWAP=$(free -m | awk 'NR==3{print $2}')
if [ "$SWAP" -eq 0 ]; then
    print_info "æ²’æœ‰ swapï¼Œæ­£åœ¨å»ºç«‹..."
    sudo fallocate -l 1G /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    print_status "Swap å»ºç«‹å®Œæˆ"
fi

# æª¢æŸ¥ç£ç¢Ÿç©ºé–“
DISK=$(df -h / | awk 'NR==2{print $5}' | sed 's/%//')
if [ "$DISK" -gt 85 ]; then
    print_error "ç£ç¢Ÿç©ºé–“ä¸è¶³: ${DISK}%"
    print_info "æ¸…ç†ä¸å¿…è¦çš„æª”æ¡ˆ..."
    sudo apt autoremove -y
    sudo apt autoclean
fi

# åœæ­¢å¯èƒ½å¡ä½çš„ Node.js é€²ç¨‹
print_info "åœæ­¢ç¾æœ‰çš„ Node.js é€²ç¨‹..."
pkill -f "node.*build" 2>/dev/null || true
pkill -f "react-scripts" 2>/dev/null || true

# æ¸…ç†ä¸¦é‡æ–°å»ºç½®
print_info "æ¸…ç†å‰ç«¯å¿«å–..."
cd client
npm cache clean --force
rm -rf node_modules/.cache 2>/dev/null || true

print_info "é‡æ–°å®‰è£ä¾è³´..."
npm ci

print_info "é–‹å§‹å»ºç½®ï¼ˆå¢åŠ è¨˜æ†¶é«”é™åˆ¶ï¼‰..."
NODE_OPTIONS="--max-old-space-size=2048" npm run build

if [ $? -eq 0 ]; then
    print_status "å»ºç½®æˆåŠŸï¼"
else
    print_error "å»ºç½®å¤±æ•—ï¼Œå˜—è©¦æ›¿ä»£æ–¹æ¡ˆ..."
    
    # å˜—è©¦ä½¿ç”¨ yarn
    if command -v yarn &> /dev/null; then
        print_info "å˜—è©¦ä½¿ç”¨ yarn å»ºç½®..."
        yarn build
    else
        print_info "å®‰è£ yarn..."
        npm install -g yarn
        yarn install
        yarn build
    fi
fi

cd ..
print_status "ä¿®å¾©è…³æœ¬åŸ·è¡Œå®Œæˆ"
EOF

chmod +x fix-build.sh
```

---

## ğŸ¯ é‡å°æ€§è§£æ±ºæ–¹æ¡ˆ

### å¦‚æœæ˜¯è¨˜æ†¶é«”å•é¡Œ
```bash
# ç«‹å³è§£æ±º
export NODE_OPTIONS="--max-old-space-size=2048"
cd client && npm run build

# æ°¸ä¹…è§£æ±º - ä¿®æ”¹ client/package.json
sed -i 's/"build": "react-scripts build"/"build": "NODE_OPTIONS=--max-old-space-size=2048 react-scripts build"/' client/package.json
```

### å¦‚æœæ˜¯ä¾è³´å•é¡Œ
```bash
# å®Œå…¨é‡æ–°å®‰è£
cd client
rm -rf node_modules package-lock.json
npm install
npm run build
```

### å¦‚æœæ˜¯ç‰ˆæœ¬è¡çª
```bash
# æª¢æŸ¥ Node.js ç‰ˆæœ¬
node --version

# å¦‚æœç‰ˆæœ¬å¤ªèˆŠï¼Œå‡ç´šåˆ° Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

---

## ğŸ” è¨ºæ–·å‘½ä»¤

### æª¢æŸ¥ç³»çµ±è³‡æº
```bash
# è¨˜æ†¶é«”ä½¿ç”¨
free -h

# CPU ä½¿ç”¨
top -n 1

# ç£ç¢Ÿç©ºé–“
df -h

# æª¢æŸ¥ Node.js é€²ç¨‹
ps aux | grep node

# æª¢æŸ¥å»ºç½®é€²ç¨‹
ps aux | grep "react-scripts\|webpack"
```

### æª¢æŸ¥å»ºç½®æ—¥èªŒ
```bash
# è©³ç´°å»ºç½®æ—¥èªŒ
cd client
npm run build --verbose 2>&1 | tee build.log

# æª¢æŸ¥éŒ¯èª¤
tail -f build.log
```

---

## ğŸš¨ ç·Šæ€¥è§£æ±ºæ–¹æ¡ˆ

### å¦‚æœå»ºç½®ä¸€ç›´å¡ä½
```bash
# 1. å¼·åˆ¶åœæ­¢æ‰€æœ‰ Node.js é€²ç¨‹
sudo pkill -f node

# 2. æ¸…ç†æ‰€æœ‰å¿«å–
npm cache clean --force
cd client
rm -rf node_modules/.cache
rm -rf build

# 3. ä½¿ç”¨æœ€å°é…ç½®å»ºç½®
cd client
CI=false npm run build

# 4. å¦‚æœé‚„æ˜¯å¤±æ•—ï¼Œä½¿ç”¨é å»ºç½®ç‰ˆæœ¬
mkdir -p build
echo '<!DOCTYPE html><html><head><title>è£œç¿’ç­ç®¡ç†ç³»çµ±</title></head><body><h1>ç³»çµ±ç¶­è­·ä¸­</h1></body></html>' > build/index.html
```

### è·³éå‰ç«¯å»ºç½®ï¼ˆè‡¨æ™‚æ–¹æ¡ˆï¼‰
```bash
# ä¿®æ”¹éƒ¨ç½²è…³æœ¬ï¼Œè·³éå‰ç«¯å»ºç½®
sed -i 's/npm run build/echo "è·³éå‰ç«¯å»ºç½®"/' ç°¡æ˜“éƒ¨ç½².sh

# åªå•Ÿå‹•å¾Œç«¯
pm2 start server/index.js --name "tutoring-backend"

# å‰ç«¯ä½¿ç”¨é–‹ç™¼æ¨¡å¼
cd client && npm start &
```

---

## ğŸ’¡ é é˜²æªæ–½

### 1. å‡ç´š VM é…ç½®
```bash
# æª¢æŸ¥ç•¶å‰é…ç½®
lscpu
free -h

# å»ºè­°æœ€å°é…ç½®ï¼š
# - 2GB RAM
# - 2 vCPU
# - 20GB ç£ç¢Ÿç©ºé–“
```

### 2. å„ªåŒ–å»ºç½®è¨­å®š
```json
// client/package.json
{
  "scripts": {
    "build": "NODE_OPTIONS='--max-old-space-size=2048' react-scripts build",
    "build:prod": "CI=false NODE_OPTIONS='--max-old-space-size=2048' react-scripts build"
  }
}
```

### 3. è¨­å®šç’°å¢ƒè®Šæ•¸
```bash
# åœ¨ ~/.bashrc ä¸­æ·»åŠ 
echo 'export NODE_OPTIONS="--max-old-space-size=2048"' >> ~/.bashrc
source ~/.bashrc
```

åŸ·è¡Œ `./fix-build.sh` è…³æœ¬ä¾†è‡ªå‹•è¨ºæ–·å’Œä¿®å¾©å•é¡Œï¼